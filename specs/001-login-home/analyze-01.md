# 規格分析報告：登入記帳主頁功能

**功能**: `001-login-home`  
**分析日期**: 2025-11-17  
**分析範圍**: spec.md, plan.md, tasks.md  
**憲章版本**: 2.0.0

---

## 執行摘要

**狀態**: ✅ **可以開始實作** （有 3 個 MEDIUM 級別問題建議改善）

分析了 3 個核心文件（spec.md, plan.md, tasks.md）和憲章要求，發現：
- **0 個 CRITICAL 問題**：無阻塞性問題
- **0 個 HIGH 問題**：無高優先級問題
- **3 個 MEDIUM 問題**：術語不一致、非功能需求覆蓋不足
- **2 個 LOW 問題**：文檔風格改善建議

所有功能需求都有對應的實作任務，測試策略符合 TDD 原則，架構設計符合憲章要求。建議在開始實作前修正術語不一致問題以避免混淆。

---

## 發現詳情

| ID | 類別 | 嚴重性 | 位置 | 摘要 | 建議 |
|----|------|--------|------|------|------|
| I1 | 不一致 | MEDIUM | spec.md (FR-010, FR-011) vs tasks.md (T052, T056) | 術語不一致：spec 使用「會話資料」，tasks 使用「Supabase 會話」、「本地 token」、「會話記錄」 | 統一術語：明確區分「Supabase Auth 會話」、「本地儲存的 token」、「sessions 表格記錄」三個概念 |
| I2 | 不一致 | MEDIUM | spec.md (關鍵實體) vs plan.md (data-model.md) vs tasks.md | 實體欄位不一致：spec 提到「登入提供商類型」，plan 詳細定義 User 有 7 個欄位（包含 `last_login_provider`），但 spec 的關鍵實體未提及此欄位 | 在 spec.md 的關鍵實體 User 描述中加入 `last_login_provider` 欄位說明 |
| I3 | 不一致 | MEDIUM | spec.md vs tasks.md | 術語不一致：spec 使用「首頁佔位顯示」、「施工中圖示」，tasks 使用「施工中 Widget」、「施工中佔位元件」 | 統一使用「施工中元件 (Under Construction Widget)」或「佔位元件 (Placeholder Widget)」 |
| C1 | 覆蓋缺口 | MEDIUM | spec.md (SC-001 至 SC-007) vs tasks.md | 成功標準 SC-001 至 SC-007 在 tasks.md 中無明確驗證任務 | 在 Phase 6 精緻化階段加入成功標準驗證任務（如 T076: 驗證登入流程 < 30 秒，T077: 驗證自動登入 < 3 秒） |
| S1 | 風格 | LOW | spec.md, plan.md, tasks.md | 三個文件的標題層級不一致：spec 使用 ## 作為主要章節，plan 使用 ## 和 ###，tasks 使用 ## | 建議統一標題層級慣例，例如 ## 作為主要章節，### 作為子章節 |
| S2 | 風格 | LOW | tasks.md | 任務描述長度不一：有些很詳細（如 T052），有些較簡短（如 T001） | 統一任務描述格式：[動作] [檔案路徑] [額外說明（選用）] |

---

## 覆蓋分析

### 功能需求覆蓋

| 需求 ID | 需求摘要 | 有任務？ | 任務 ID | 備註 |
|---------|---------|---------|---------|------|
| FR-001 | Google 登入選項 | ✅ | T040, T035, T028 | 包含 UI、用例、資料源 |
| FR-002 | Facebook 登入選項 | ✅ | T041, T036, T028 | 包含 UI、用例、資料源 |
| FR-003 | 啟動授權流程 | ✅ | T028, T040, T041 | 整合於登入按鈕和資料源 |
| FR-004 | 接收使用者資訊 | ✅ | T028, T029, T026 | 資料源和模型定義 |
| FR-004a | 儲存使用者資訊 | ✅ | T029, T046 | Repository 和會話記錄 |
| FR-005 | 儲存會話狀態 | ✅ | T029, T030, T027 | Repository 和 Session 模型 |
| FR-006 | 自動檢查會話 | ✅ | T037, T043 | 檢查認證狀態用例和路由邏輯 |
| FR-007 | 會話有效自動導向 | ✅ | T043 | 路由邏輯 |
| FR-008 | 會話失效顯示登入 | ✅ | T043, T064 | 路由邏輯和過期處理 |
| FR-008a | 記住登入提供商 | ✅ | T047 | 實作記住上次登入提供商 |
| FR-009 | 提供登出按鈕 | ✅ | T054 | 首頁實作 |
| FR-010 | 登出清除會話 | ✅ | T052, T056 | 登出用例和會話清理 |
| FR-011 | 登出導向登入頁 | ✅ | T055 | 路由邏輯更新 |
| FR-012 | 登出後不自動登入 | ✅ | T052 | 登出用例清除狀態 |
| FR-013 | 登入後顯示首頁 | ✅ | T054 | 首頁實作 |
| FR-014 | 顯示施工中圖示 | ✅ | T060, T061 | 施工中 Widget |
| FR-015 | 顯示說明文字 | ✅ | T060, T061 | 施工中 Widget |
| FR-016 | 提供登出入口 | ✅ | T054 | 首頁實作 |
| FR-017 | 網路錯誤處理 | ✅ | T044, T065 | 錯誤處理和網路錯誤 |
| FR-018 | 授權失敗處理 | ✅ | T044 | 錯誤處理 |
| FR-019 | 授權取消處理 | ✅ | T066 | 授權取消處理 |
| FR-020 | 會話過期處理 | ✅ | T064 | 會話過期處理 |

**覆蓋率**: 22/22 (100%) - 所有功能需求都有對應任務 ✅

### 非功能需求覆蓋

| 成功標準 ID | 標準摘要 | 有任務？ | 任務 ID | 備註 |
|------------|---------|---------|---------|------|
| SC-001 | 登入流程 < 30 秒 | ⚠️ | - | 無明確驗證任務，建議加入效能測試 |
| SC-002 | 95% 登入成功率 | ⚠️ | T024, T025 | 整合測試涵蓋，但無明確成功率監控 |
| SC-003 | 自動登入 < 3 秒 | ⚠️ | - | 無明確驗證任務，建議加入效能測試 |
| SC-004 | 登出操作 < 5 秒 | ⚠️ | T051 | 整合測試涵蓋，但無明確時間驗證 |
| SC-005 | 100% 錯誤訊息顯示 | ✅ | T044, T065, T066 | 錯誤處理任務涵蓋 |
| SC-006 | 響應式設計支援 | ⚠️ | - | 無明確驗證任務，建議加入 Widget 測試 |
| SC-007 | 90% 首次成功率 | ⚠️ | - | 無明確驗證任務，需 E2E 測試驗證 |

**覆蓋率**: 1/7 (14%) 明確覆蓋，6/7 (86%) 隱含覆蓋但無驗證任務 ⚠️

### 使用者故事覆蓋

| 故事 ID | 故事摘要 | 任務數 | 測試任務數 | 備註 |
|---------|---------|--------|-----------|------|
| US1 | 社群帳號登入 | 31 | 8 | 完整覆蓋，包含 TDD 測試 ✅ |
| US2 | 登出功能 | 9 | 3 | 完整覆蓋，包含 TDD 測試 ✅ |
| US3 | 首頁佔位顯示 | 6 | 2 | 完整覆蓋，包含 TDD 測試 ✅ |

**覆蓋率**: 3/3 (100%) - 所有使用者故事都有完整任務分解 ✅

### 未映射任務

**無未映射任務** - 所有任務都明確關聯到使用者故事或基礎建設階段 ✅

---

## 憲章對齊分析

### I. 程式碼品質 (NON-NEGOTIABLE)

✅ **符合** - plan.md 明確定義使用 `flutter_lints`、`dart analyze`、dartdoc 註解  
✅ **符合** - 專案結構遵循 Feature-First + Clean Architecture，維持單一職責  
✅ **符合** - tasks.md 包含程式碼品質任務（T003, T071, T074）

### II. 測試標準 (NON-NEGOTIABLE)

✅ **符合** - tasks.md 明確遵循 TDD 流程：「先寫測試，確保失敗後才開始實作」  
✅ **符合** - plan.md 定義測試金字塔：70% 單元測試、20% 整合測試、10% E2E 測試  
✅ **符合** - 每個使用者故事都有完整測試任務（US1: 8 個測試，US2: 3 個測試，US3: 2 個測試）  
✅ **符合** - 測試覆蓋率目標明確：業務邏輯 ≥ 80%，認證流程 = 100%（T072）

### III. 使用者體驗一致性

✅ **符合** - spec.md 定義完整設計規格（色彩系統、文字樣式、間距系統、視覺元件規格）  
✅ **符合** - tasks.md 包含無障礙任務（T067: Semantics 標籤）  
✅ **符合** - 錯誤處理任務明確（T044: 轉換為使用者友善訊息）  
✅ **符合** - 即時回饋任務明確（T045: loading 狀態顯示）

### IV. 效能需求

✅ **符合** - plan.md 定義效能目標：登入 < 30s、自動登入 < 3s、UI ≥ 60fps  
⚠️ **部分符合** - tasks.md 包含效能優化任務（T068），但缺少效能驗證任務  
💡 **建議** - 加入效能測試任務驗證 SC-001（登入 < 30s）和 SC-003（自動登入 < 3s）

### V. 可維護性與簡潔性

✅ **符合** - plan.md 遵循 YAGNI 原則，技術棧最小化  
✅ **符合** - tasks.md 包含文件任務（T069: README.md、T070: architecture.md）  
✅ **符合** - 專案結構清晰，採用 Feature-First 架構

### 語言與文件要求

✅ **符合** - 所有文件（spec.md, plan.md, tasks.md）都使用繁體中文撰寫  
✅ **符合** - 程式碼路徑和技術術語使用英文（符合憲章「程式碼註解可用中文或英文」）

---

## 重複檢測

**無重複需求** - 所有功能需求互相獨立，無語義重複 ✅

---

## 模糊性檢測

| 位置 | 模糊內容 | 說明 | 建議 |
|------|---------|------|------|
| spec.md:SC-002 | 「正常網路條件」 | 未定義何謂「正常網路」 | 明確定義：如「4G/WiFi，延遲 < 200ms，丟包率 < 1%」 |
| spec.md:SC-007 | 「90% 使用者首次成功」 | 未定義如何衡量 | 明確定義：透過分析工具追蹤或使用者測試驗證 |
| tasks.md:T001 | 「建立 Flutter 專案結構依照 plan.md 的架構設計」 | 描述模糊，未明確說明具體動作 | 改為：「建立 lib/features/, lib/core/, lib/shared/ 目錄結構，參考 plan.md 專案結構章節」 |

---

## 規格不足檢測

| 位置 | 不足內容 | 說明 | 建議 |
|------|---------|------|------|
| spec.md:邊緣案例 | 「多裝置登入」 | 只說明行為，未定義資料模型如何支援 | plan.md 已補充（Session 包含 deviceId），建議在 spec 中交叉引用 |
| plan.md:研究任務 | 「輸出至 research.md」 | 未定義 research.md 的具體格式和必要章節 | 加入 research.md 範本章節（決策、理由、替代方案） |
| tasks.md:Phase 6 | 「精緻化與跨領域關注」 | 缺少成功標準（SC-001 至 SC-007）的驗證任務 | 加入效能測試任務驗證成功標準 |

---

## 指標統計

| 指標 | 數值 | 備註 |
|-----|------|------|
| 總功能需求數 | 22 | FR-001 至 FR-020，加 FR-004a, FR-008a |
| 總任務數 | 75 | Phase 1 至 Phase 6 |
| 功能需求覆蓋率 | 100% (22/22) | 所有需求都有對應任務 ✅ |
| 非功能需求明確覆蓋率 | 14% (1/7) | 只有 SC-005 有明確任務 ⚠️ |
| 使用者故事覆蓋率 | 100% (3/3) | US1, US2, US3 都有完整任務 ✅ |
| 模糊性問題數 | 3 | 輕微模糊，不阻塞實作 |
| 重複需求數 | 0 | 無重複 ✅ |
| 術語不一致數 | 3 | MEDIUM 級別，建議修正 |
| CRITICAL 問題數 | 0 | 無阻塞性問題 ✅ |
| HIGH 問題數 | 0 | 無高優先級問題 ✅ |
| MEDIUM 問題數 | 3 | I1, I2, I3 |
| LOW 問題數 | 2 | S1, S2 |

---

## 下一步行動

### ✅ 可以開始實作

本功能規格分析通過，可以開始 Phase 1（設定）和 Phase 2（基礎建設）的實作。

### 💡 建議改善（非阻塞）

**優先處理（MEDIUM 級別）：**

1. **修正術語不一致（I1, I2, I3）**
   - 統一會話相關術語（Supabase Auth 會話、本地 token、sessions 表格記錄）
   - 在 spec.md 關鍵實體中加入 `last_login_provider` 欄位
   - 統一使用「施工中元件」術語
   
   **執行方式**: 手動編輯 spec.md 和 tasks.md

2. **加入成功標準驗證任務（C1）**
   - 在 Phase 6 加入效能測試任務驗證 SC-001（登入 < 30s）和 SC-003（自動登入 < 3s）
   - 在 Phase 6 加入響應式設計測試驗證 SC-006
   
   **執行方式**: 編輯 tasks.md，加入新任務 T076, T077, T078

**次要改善（LOW 級別）：**

3. **統一文件格式（S1, S2）**
   - 統一三個文件的標題層級慣例
   - 統一 tasks.md 任務描述格式
   
   **執行方式**: 手動重新格式化

### 🔧 如何進行修正

**選項 1: 手動修正**
- 使用文字編輯器修正 spec.md 和 tasks.md 的術語不一致
- 在 tasks.md Phase 6 加入新任務

**選項 2: 要求 AI 協助**
- 提供具體修正指示讓 AI 執行 `replace_string_in_file` 操作

---

## 修正建議

### 建議 1: 修正 spec.md 術語不一致（I2）

**位置**: `spec.md` 的「關鍵實體」章節

**當前內容**:
```markdown
- **使用者 (User)**: 代表一個已登入的使用者帳號，包含從社群平台取得的基本資訊（使用者 ID、姓名、電子郵件、頭像 URL、登入提供商類型）。
```

**建議修改為**:
```markdown
- **使用者 (User)**: 代表一個已登入的使用者帳號，包含從社群平台取得的基本資訊（使用者 ID、姓名、電子郵件、頭像 URL、當前登入提供商類型、上次使用的登入提供商）。此資料儲存於裝置本地和伺服器端，用於身份識別、顯示使用者資訊，並支援會話過期後記住使用者偏好的登入方式。
```

### 建議 2: 在 tasks.md 加入成功標準驗證任務（C1）

**位置**: `tasks.md` Phase 6 精緻化階段

**加入以下任務**:
```markdown
- [ ] T076 [P] 建立 integration_test/performance/login_performance_test.dart 驗證登入流程時間 < 30 秒（SC-001）
- [ ] T077 [P] 建立 integration_test/performance/auto_login_performance_test.dart 驗證自動登入時間 < 3 秒（SC-003）
- [ ] T078 [P] 建立 test/widget/responsive_design_test.dart 驗證各螢幕尺寸正確顯示（SC-006）
```

### 建議 3: 統一會話術語（I1）

**建議在 spec.md 開頭加入術語定義章節**:
```markdown
## 術語定義

- **Supabase Auth 會話**: Supabase 認證服務維護的伺服器端會話，包含 access_token 和 refresh_token
- **本地 token**: 儲存於裝置本地（Flutter Secure Storage）的 access_token 和 refresh_token
- **會話記錄**: Supabase Database 中 `sessions` 表格的記錄，用於追蹤多裝置登入和裝置資訊
```

---

## 總結

本功能規格分析顯示：
- ✅ **功能完整性**: 所有功能需求和使用者故事都有對應任務
- ✅ **憲章對齊**: 符合所有 NON-NEGOTIABLE 原則
- ✅ **測試策略**: 遵循 TDD，測試覆蓋完整
- ⚠️ **術語一致性**: 有 3 個 MEDIUM 級別不一致需改善
- ⚠️ **非功能驗證**: 缺少部分成功標準的明確驗證任務

**建議**: 在開始實作前花費 1-2 小時修正術語不一致和加入成功標準驗證任務，以避免後續混淆和遺漏效能驗證。修正後可立即開始 Phase 1 和 Phase 2 的實作。

---

**分析工具版本**: speckit.analyze v1.0  
**報告產生時間**: 2025-11-17  
**分析者**: GitHub Copilot (Claude Sonnet 4.5)
